{
  "info": {
    "name": "Node EJS Shop API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0",
    "description": "Collection to test API endpoints for the Node EJS Postgres shop project. Import into Postman or run with Newman."
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3001" },
    { "key": "token", "value": "" },
    { "key": "productId", "value": "" },
    { "key": "orderId", "value": "" }
  ],
  "item": [
    {
      "name": "Auth - Register",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"duong123@gmail.com\",\n  \"Duong123\": \"secret123\",\n  \"name\": \"API User\"\n}" },
        "url": { "raw": "{{baseUrl}}/api/auth/register", "host": [ "{{baseUrl}}" ], "path": [ "api","auth","register" ] }
      },
      "response": [],
      "event": [
        {
          "listen": "test",
          "script": { "exec": [ "pm.test('register returns 200 or 201', function(){ pm.expect(pm.response.code).to.be.oneOf([200,201]); });" ] }
        }
      ]
    },
    {
      "name": "Auth - Login (captures token cookie)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"secret123\"\n}" },
        "url": { "raw": "{{baseUrl}}/api/auth/login", "host": [ "{{baseUrl}}" ], "path": [ "api","auth","login" ] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('login OK', function(){ pm.expect(pm.response.code).to.equal(200); });",
              "// try to capture token from Set-Cookie header",
              "var sc = pm.response.headers.get('set-cookie');",
              "if (sc) { var m = sc.match(/token=([^;]+)/); if (m) pm.environment.set('token', m[1]); }",
              "pm.test('token saved to environment if present', function(){ pm.expect(pm.environment.get('token')||'').to.be.a('string'); });"
            ]
          }
        }
      ]
    },
    {
      "name": "Auth - Me",
      "request": {
        "method": "GET",
        "header": [ { "key": "Cookie", "value": "token={{token}}" } ],
        "url": { "raw": "{{baseUrl}}/api/auth/me", "host": [ "{{baseUrl}}" ], "path": [ "api","auth","me" ] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('me returns 200', function(){ pm.expect(pm.response.code).to.equal(200); });" ] } } ]
    },
    {
      "name": "Products - List",
      "request": { "method": "GET", "url": { "raw": "{{baseUrl}}/api/products", "host": [ "{{baseUrl}}" ], "path": [ "api","products" ] } },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('products list ok (200 or 500)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,500]); });" ] } } ]
    },
    {
      "name": "Products - Create (admin)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Cookie", "value": "token={{token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"name\": \"API Product\",\n  \"slug\": \"api-product-1\",\n  \"price\": 9.99,\n  \"stock\": 10\n}" },
        "url": { "raw": "{{baseUrl}}/api/products", "host": [ "{{baseUrl}}" ], "path": [ "api","products" ] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('create product 201/200/403', function(){ pm.expect(pm.response.code).to.be.oneOf([200,201,403]); });",
              "if (pm.response.headers.get('content-type') && pm.response.headers.get('content-type').includes('application/json')) { try { var json = pm.response.json(); if (json && json.id) pm.environment.set('productId', json.id); } catch(e){} }"
            ]
          }
        }
      ]
    },
    {
      "name": "Products - Get Detail",
      "request": {
        "method": "GET",
        "header": [],
        "url": { "raw": "{{baseUrl}}/api/products/{{productId}}", "host": [ "{{baseUrl}}" ], "path": [ "api","products","{{productId}}" ] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('product detail 200/404/500', function(){ pm.expect(pm.response.code).to.be.oneOf([200,404,500]); });" ] } } ]
    },
    {
      "name": "Cart - Add",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Cookie", "value": "token={{token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"product_id\": {{productId}},\n  \"qty\": 1\n}" },
        "url": { "raw": "{{baseUrl}}/api/cart/add", "host": [ "{{baseUrl}}" ], "path": [ "api","cart","add" ] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('cart add ok (200 or 400)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,400]); });" ] } } ]
    },
    {
      "name": "Cart - Get",
      "request": { "method": "GET", "header": [ { "key": "Cookie", "value": "token={{token}}" } ], "url": { "raw": "{{baseUrl}}/api/cart", "host": [ "{{baseUrl}}" ], "path": [ "api","cart" ] } },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('cart get ok (200 or 500)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,500]); });" ] } } ]
    },
    {
      "name": "Addresses - Create",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Cookie", "value": "token={{token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"name\": \"Home\",\n  \"phone\": \"0123456789\",\n  \"address\": \"123 Main St\",\n  \"city\": \"Hanoi\",\n  \"is_default\": true\n}" },
        "url": { "raw": "{{baseUrl}}/api/addresses", "host": [ "{{baseUrl}}" ], "path": [ "api","addresses" ] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('address created (200/201/500)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,201,500]); });" ] } } ]
    },
    {
      "name": "Addresses - List",
      "request": { "method": "GET", "header": [ { "key": "Cookie", "value": "token={{token}}" } ], "url": { "raw": "{{baseUrl}}/api/addresses", "host": [ "{{baseUrl}}" ], "path": [ "api","addresses" ] } },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('addresses list ok (200 or 500)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,500]); });" ] } } ]
    },
    {
      "name": "Orders - Create COD",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Cookie", "value": "token={{token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"payment_method\": \"cod\",\n  \"address_id\": 1,\n  \"ship_method\": \"standard\"\n}" },
        "url": { "raw": "{{baseUrl}}/api/orders/create", "host": [ "{{baseUrl}}" ], "path": [ "api","orders","create" ] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('create cod order (200 or 400)', function(){ pm.expect(pm.response.code).to.be.oneOf([200,400]); });",
              "if (pm.response.headers.get('content-type') && pm.response.headers.get('content-type').includes('application/json')) { try { var json = pm.response.json(); if (json && json.redirect) { /* nothing */ } } catch(e){} }"
            ]
          }
        }
      ]
    },
    {
      "name": "Orders - List",
      "request": { "method": "GET", "header": [ { "key": "Cookie", "value": "token={{token}}" } ], "url": { "raw": "{{baseUrl}}/api/orders", "host": [ "{{baseUrl}}" ], "path": [ "api","orders" ] } },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('orders list ok', function(){ pm.expect(pm.response.code).to.equal(200); });" ] } } ]
    }
  ]
}
